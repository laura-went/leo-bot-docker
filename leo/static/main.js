var supportive = ["Be happy, it drives people crazy.&#128540;",
              "Optimist: someone who figures that taking a step backward after taking a step "+
              "forward is not a disaster; it's more like a cha-cha.",
              "Live each day like it's your second to the last. That way you can fall asleep at night.",
              "Yesterday is history. Tomorrow is a mystery. Today is a gift. That's why we call it 'The Present.",
              "Life itself is the most wonderful fairy tale.",
              "A big part of being a well-adjusted person is accepting that you can’t be good at everything.",
              "Believe that life is worth living and your belief will help create the fact.",
              "Choose to be optimistic, it feels better.&#128524;",
              "In three words I can sum up everything I’ve learned about life. It goes on.",
              "It doesn’t matter how slow you go, as long as you don’t stop.",
              "Success is the sum of small efforts, repeated day-in and day-out.&#129299;",
              "You may have to fight a battle more than once to win it.",
              "If it’s not exactly like you thought it would be, you think it’s a failure. What about the "+
              "spectrum of colors in between.",
              "Just because you fail once doesn't mean you're gonna fail at everything.",
              "To succeed, you have to do something and be very bad at it for a while. You have to "+
              "look bad before you can look really good.",
              "If you don’t like something change it; if you can’t change it, change the way you think about it.",
              "If you embrace your flaws, nobody can use them against you.&#128525;",
              "Always concentrate on how far you have come, rather than how far you have left to go. ",
              "The difference in how easy it seems will amaze you.",
              "Build your own dreams or someone else will hire you to build theirs.",
              "Real difficulties can be overcome; &#128170; it is only the imaginary ones that are unconquerable.",
              "Success is not final, failure is not fatal: it is the courage to continue that counts.",
              "Believe you can and you're halfway there.",
              "The Way Get Started Is To Quit Talking And Begin Doing.",
              "Don’t Let Yesterday Take Up Too Much Of Today.",
              "People Who Are Crazy Enough To Think They Can Change The World, Are The Ones Who Do.",
              "Don't let your struggle become your identity.",
              "Your spirit has the energy, strength, and stamina of 10,000 horses."
              ]
var wellbeing = ["So I'm interested, do you care about morally well-being?*2",
             "I have a funny question for you &#128517;, do you obey the law when driving or as a pedestrian?*1",
             "I think all people are visionaries. Do you think you have a vision behind every step you follow?*1"]
var sensitivity = ["We live in a crazy world right? Are you easily overwhelmed by sensory stimuli?*2",
               "So, do you get rattled when you have to do a lot in a short amount of time?*3",
               "I hope you surround yourself with good people, but do you know what needs to be done to "+
               "help others get out of an uncomfortable situation?*1",
               "Do you know the feeling of being uncomfortable &#128534;?*2",
               "Do you actively try to avoid upsetting or overwhelming situations?*1",
               "When you were a child, did your parents or teachers see you as sensitive or shy?*2"]
var selfesteem = ["We all have moments which don't feel nice. Do you sometimes feel humiliated, which makes you angry?*2",
              "Even though you're a beautiful human being, are you insecure about yourself?*2",
              "We all need to express our feelings. Do you feel worse after expressing your feelings?*1",
              "Do you feel that other people should respect you more &#129300;?*2",
              "Are you dissatisfied with yourself?*2"]
var mood = ["Life can be rough. Do you see up to doing certain things at the moment?*2",
        "How did last week go, have you had any emotional events?*2",
        "I’m here for you, but even then, do you still feel lonely?*2",
        "I hope you had a good week &#128522;, but did anything significant happen this week?*1",
        "Do you get affected by negative emotions?*1"]
var interactions = ["I feel we can chat about anything, so I hope I can ask you the next thing as well &#128580;. "+
                "Do you hold a recessive position in your social circle?*1",
                "If you're honest with me, do you feel lack of empathy for others?*3",
                "If you think about your feedback, do you think your angry feedback will be constructive for others?*1",
                "Has anyone or anything upset you last week?*2",
                "Do you dislike conversations and the people you talk to?*2",
							"So about your social connections. Do you look for entitlement in your social circle?*3"]
var anger = ["Some people can give you the impression that you're not important, but you are."+
         "So do you sometimes feel unheard?*2",
         "Have you been unjustly treated?*2",
         "We can't be friends with everyone &#128543;. But do others put you in a negative situation?*2",
         "Does something often not go wrong in your life?*2",
         "Do you feel like you have to suppress your own emotions for someone or something else?*2",
         "For some people it helps to get something physically out of their system, by screaming or doing sports "+
         "for example. Do you think that would help you?*2"]
var bully = ["Do you like school?*1",
         "Do your friends like to make fun or harrass others or you?*2",
         "If you're honest, did you ever say hurtful things to someone or excluded that person?*3",
         "I think you don't want to answer this, but did you ever physically harm someone?*3"]
var victim = ["Do you dislike school?*2",
          "Do you have little friends?*1",
          "We have all experienced sad situations, but did anyone ever say hurtful things to you or excluded you?*2",
          "This may be a tough question, but have you ever been physically harmed?*2"]
var wellbeing_support = ["You should know that you don’t have to give up, there are many good things coming!",
                     "Your wellbeing is important to me and it should be important to yourself as well &#128521;.",
                     "You don’t always have to feel like the best version of yourself, but remember that better "+
                     "times will definitely come.",
                     "Life is so precious, it sounds cliche, but “You only live once” is true.",
                     "You can try to make the best out of a situation, if it afterwards still bothers you, then you "+
                     "should leave it be as you’ve already did your best and there’s nothing else you then can do."]
var selfesteem_support = ["Don’t be afraid to stand up for yourself!",
                      "You have the power to change any situation you want.",
                      "Think about all the amazing accomplishments you’ve achieved already in your life!",
                      "It feels like your confidence can use a boost &#128516;, remember that you’re a wholesome person and "+
                      "you can handle more than you think.",
                      "I would say you can change this situation. What you need to do for now is to think about "+
                      "what you can do in order to solve this problem."]
var sensitivity_support = ["It seems like your senses are strong, try to use them in the best way possible!",
                       "Sometimes you can’t change a situation, you then have to learn how to not get overstimulated "+
                       "by it.",
                       "I can imagine you had some difficult times. Some emotions can eat you up and be very "+
                       "exhausting, so try to rest enough in such times. &#128564;"]
var mood_support = ["You seem a bit down. Remember that after rain comes sunshine.",
                "I feel for you. Some situations are hard to deal with…",
                "Remember to not let emotions control your life!",
                "Think about your happy place &#128519;, or something that brings joy to your life. Those kind of tricks can "+
                "help you get into a better mindset.",
                "Sometimes we have days which are just not that great, and that’s ok. Every day is a new chance to "+
                "change the bad things in life."]
var interactions_support = ["Remember to be open to what other people have to say around you. You can’t change others, "+
                        "but you can change yourself.",
                        "Constructive feedback from your peers can be beneficial to your self-growth, and make you an "+
                        "even better person!",
                        "Surround yourself with people who uplift you and see you as good as you see them.",
                        "Be good to others, and then others will be good to you. &#128513;",
                        "Patience is a skill not many people have mastered. "]
var anger_support = ["I sense you might be bothered now. Try focusing on something else or changing your perspective! &#129488;",
                 "It can be good to talk about your feelings with someone. It’s never a good idea to keep them "+
                 "boiling inside you.",
                 "Surround yourself with people or things you love and don’t focus on the bad things in life, "+
                 "those are not worth your energy.",
                 "I really like to see you be the happy person you can be, and love to be here for you even when "+
                 "you’re not. &#128522;"]
var victim_support = ["It’s important to surround yourself with good energy.",
                  "Don’t be friends with people who kick you down, but rather with ones who lift you up &#128525;.",
                  "You don’t know why other people are the way they are, but remember that everyone goes through "+
                  "something and some people get this out of their system in a wrong way. &#128533;"]
var bully_support = ["Try to focus on your own life and improve it in every way you can.",
                 "Don’t try to project your feelings onto others, as every person lives a different life.",
                 "Try to lift others up and you will see that life will surprise you in a positive way! &#128523;"]
var answers=["<br>You know you can let it all out with me right?",
             "<br>You can speak your mind if you want?",
             "<br>You can say something about it now...?",
             "<br>What do you think?"]
URL = window.URL || window.webkitURL;

var gumStream;
var rec;
var input;
var AudioContext = window.AudioContext || window.webkitAudioContext;
var audioContext;

var to_support = [];
var negative = ['angry', 'disgust', 'anger'];
var neutral = ['neutral', 'calm', 'analytical', 'tentative'];
var positive = ['happy', 'surprised', 'joy', 'confident'];
var other = ['sad', 'fearful', 'fear', 'sadness'];

var category_dict = {};
var value_dict = {};
var selfesteem_dict = [];
var wellbeing_dict = [];
var interactions_dict = [];
var mood_dict = [];
var sensitivity_dict = [];
var bully_dict = [];
var anger_dict = [];
var victim_dict = [];
var voices, utterance;
var faceNumber = "40";
var faceNumber2, link;
var response200;
var finalface;
var speech, emotion;
var value = 0;
var final = 0;
var selfesteem_value = 0;
var interactions_value = 0;
var mood_value = 0;
var wellbeing_value = 0;
var sensitivity_value = 0;
var anger_value = 0;
var bully_value = 0;
var victim_value = 0;
var response_value;
var bare_sentence;
var innerDiv, innerDiv2;
var name;
var br = document.createElement("br");
const delay = 150
const defaultFace = "40"
const blink = "41"
var read_or_speak = 0;
var save_text = 2;
var total_text = "";
var name;

const start = Date.now()
var messageCounter = 0;
const faceMap = {
  "40":["b","p","m"],
  "44":["c","x","sh","s"],
  "48":["g","j","k","n","r","t","v","z","f"],
  "50":["a","i"],
  "53":["d","l","th","e","h"],
  "57":["q","u","w","y","o"],
}
// --------------------------------------------------------------------

// on ready
$(document).ready(function() {
  $("#chat-message-mic").hide();
  $("#chat-message-start").hide();
  $(".typefield").hide();
  $(".emoji").hide();
  $("#40").show();
  blinker()
	text = "Hi there! &#128516; What's your name?"
  addLeo();
});

const faces = Object.keys(faceMap);


function read_or_listen(_callback){
  const options = {
    once: true
  }
  if(read_or_speak==0) {
    document.querySelector('#chat-message-mic').addEventListener('click', () => {
      listen(_callback);
    }, options);
  } else {
     document.querySelector('#chat-message-start').addEventListener('click', () => {
       read(_callback);
     }, options);
  }
}


// beginning continues part 2
function both2(result){
  console.log("in both2!")
  speech = result[0];
	emotion = result[1]['list'];
	if (!speech.includes('no')){
    text = "First tell me, how are you feeling today?";
    save_text=1;
    addLeo();
    speakVoice(text);
    read_or_listen(selfesteem1);
	}
	else {
    addLeo();
		speakVoice("Ok, we can chat for a bit as well. <br>Just say 'goodbye computer' " +
    "if you're done. <br>Or include the word 'question' in your sentence if you'd " +
    "still like to talk about personal stuff.<br>Now tell me "+name+", what would you like to talk about?");
    read_or_listen(casual1);
  }
}

// beginning continues
function both(result){
	name = result[0];
  console.log(name);
	emotion = result[1]['list'];
  text = "So " + name + ", would you like to chat about how to make the world better for you?"
  addLeo();
  speakVoice(text);
  console.log(read_or_speak);
  read_or_listen(both2);
};

let first_run = [both, both2, casual1, casual2];
let run_counter = 0;
function buttonListener() {

  run_counter
}

function speech(){
  $("#chat-message-volume").hide();
  $("#chat-message-volume2").hide();
  $("#chat-message-start").hide();
  $("#typefield").hide();
  $("#chat-message-mic").show();
  speakVoice(text);
  read_or_speak=0;
  beginning();
}

function toText(){
  $("#chat-message-volume").hide();
  $("#chat-message-volume2").hide();
  $("#chat-message-start").show();
  $("#typefield").show();
  $("#chat-message-mic").hide();
  speakVoice(text);
  read_or_speak=1;
  beginning();
}
// !!!!!!!!!!!!!!!!BEGINNING!!!!!!!!!!!!!!!!!
function beginning(){
  console.log(read_or_speak)
  read_or_listen(both);
}


// constant blinking of bot
async function blinker(){
  setInterval(function(){
    $('#40').attr('src', "../../static/img/41.png");
    setTimeout(function(){$('#40').attr('src', "../../static/img/40.png");},200);
  }, 6000)
}


// convert text (phoneme?) to certain face bot
function resolveCharacter(message, index) {
  const character = String(message).toLowerCase()[index]
  const previousDouble = String(message).toLowerCase().substr(index - 1, index + 1)
  const nextDouble = String(message).toLowerCase().substr(index, index + 2)
  return faces.find(e => faceMap[e].indexOf(previousDouble) !== -1) ||
    faces.find(e => faceMap[e].indexOf(nextDouble) !== -1) || faces.find(e => faceMap[e].indexOf(character) !== -1)
}

// speak (speech+face moving) and append text of bot
function speakVoice(text) {
  var texts = text.split(/<br>/);
  console.log(texts)
  document.getElementById(messageCounter).innerHTML = text
  messageCounter++;
  console.log(innerDiv)
  text = text.replace(/<br>/, "<br>")
  text = text.replace("<br>", "<br>")
  text = text.replace(/&.*;/, "")
  document.getElementById("newchat").scrollTop = document.getElementById("newchat").scrollHeight;

  var timer = setInterval(function() {
    const index = Math.floor(( Date.now() - start )  / delay)%(text.length+1)
    faceNumber2 = resolveCharacter(text, index)
    if(!faceNumber2){
      faceNumber2 = "40";
    }
    $('#'+faceNumber).attr('src', "../../static/img/"+faceNumber2+".png");
    finalface = faceNumber;
    faceNumber=faceNumber2
    if (i === text.length+5){
      $('#40').attr('src', "../../static/img/40.png");
      clearInterval(timer);
     }
    i++
  },68);
  const synth = window.speechSynthesis
	const utter = new SpeechSynthesisUtterance(text)
  const voices = synth.getVoices()
  utter.voice = voices[5]
  synth.speak(utter)
  var i = 0;
  if (synth.speaking){
    console.log('speaking')
  }
  $('#'+finalface).attr('src', "../../static/img/40.png");


};


// compare how many positive vs negative detected emotions there are per category
function compare(arr1){
  var neg_dict = {'angry': 0, 'disgust': 0, 'anger': 0, 'sad': 0, "fearful": 0, 'fear': 0, 'sadness': 0}
  var pos_dict = {'neutral': 0, 'calm': 0, 'analytical': 0, 'tentative': 0, 'happy': 0, 'surprised': 0, 'joy': 0}
  arr2 = arr1[0].concat(arr1[1],arr1[2])
  console.log(arr2)
  for (var i=0; i<arr2.length; i++){
    if (arr2[i] in neg_dict){
      neg_dict[arr2[i]]++;
    }
    else if (arr2[i] in pos_dict){
      pos_dict[arr2[i]]++;
    }
  }
  var neg_total = Object.values(neg_dict).reduce((a, b) => a + b, 0)
  var pos_total = Object.values(pos_dict).reduce((a, b) => a + b, 0)
  console.log('compare: ',neg_total, pos_total)
  return neg_total > pos_total
}

// final feedback after all questions
function finalFeedback(result){
  var totalList = [[selfesteem_dict,selfesteem_support, 'self-esteem', value_dict['selfesteem']],
  [wellbeing_dict,wellbeing_support, 'well-being', value_dict['wellbeing']],
  [interactions_dict,interactions_support, 'interactions', value_dict['interactions']],
  [mood_dict, mood_support, 'mood', value_dict['mood']],
  [sensitivity_dict, sensitivity_support, 'sensitivity', value_dict['sensitivity']],
  [bully_dict, bully_support, 'bullying', value_dict['bully']],
  [anger_dict, anger_support, 'anger', value_dict['anger']],
  [victim_dict, victim_support, 'bullied', value_dict['victim']]];
  console.log(totalList[final][2],totalList[final][0], totalList[final][3])
  if (totalList[final][0].length!=0 && totalList[final][3]>=0.5){
    console.log('this category was asked')
    text = "Thanks for sharing with me &#128522;.<br>";
    response = random(totalList[final][1]);
  	var index = totalList[final][1].indexOf(response);
  	totalList[final][1].splice(index, 1);
    if (totalList[final][2]=='bullying' || totalList[final][2]=='bullied'){
      console.log('category is bully/victim')
      if(compare(totalList[final][0])){
        text = "If I'm not mistaken, you've been "+totalList[final][2]+" in some form? That's never OK!<br>"+
        "Also I don't think you have any positive emotions about it.<br>"+ response
      }
      else {
        text = "It doesn't seem to bother you that you've been "+totalList[final][2]+".<br>"+response
      }
    }
    else{
      console.log('category is NOT bully/victim')
      if(compare(totalList[final][0])){
        text = "So... I've sensed some unfavourable emotions towards your "+ totalList[final][2]+", "+name+".<br>"+response
      }
      else {
        text = "You seem emotionally fine about your "+ totalList[final][2]+", even though those are topics you seem to "+
        "struggle with.<br>"+response
      }
    }
    final++;
    console.log(final, totalList.length)
    if (final >= totalList.length){
      console.log('walked through whole totalList')
      addLeo();
      speakVoice(text);
      finalFeedback2();
    }else{
      console.log('still going')
      text+=random(answers);
      addLeo();
      speakVoice(text);
      console.log()
      read_or_listen(finalFeedback);

    }
  }
  else{
    final ++;
    console.log('thing not filled ',final)
    if (final == totalList.length){
      finalFeedback2();
    }else{
      console.log('still going')
      finalFeedback();
    }
  }
}

function finalFeedback2(){
  text= "Now something more lightweight to talk about! If you don't want to, just say goodbye computer. But can I ask you first, do you feel a little bit better now after our conversation?";
  save_text=1;
  addLeo();
  speakVoice(text);
  read_or_listen(casual1);
}

// casual chat part 1
function casual1(speech2){
  bare_sentence = speech2[0];
  if (bare_sentence.includes('question')){
    both2(speech2);
  }
  else if (bare_sentence != 'goodbye computer'){
    createsentence(casual2);
  }
  else{
    // send name and text and exit
    var url = "add_to_db";
  	var fd = new FormData();
    fd.append('name', name)
  	fd.append('text', total_text);
  	$.ajax({
  		type: 'POST',
  		url: url,
  		data: fd,
  		processData: false,
  		contentType: false,
  		success: function(response) {
        console.log(response)
  			exit(response);
  		}
  	}).done(function(data) {
  	});
  }
}

function exit(result){
  $("#chat-message-mic").hide();
  $("#chat-message-volume").hide();
  text = "It was nice talking to you, "+name+"! Hope to see you soon again. &#128522;";
  addLeo();
  speakVoice(text)
}

// casual chat part 2
function casual2(result){
  chatbot_response = result;
  addLeo();
  speakVoice(chatbot_response);
  read_or_listen(casual1);
}

// create sentence for casual chat
function createsentence(callback){
  var url = "casual";
	var fd = new FormData();
	fd.append('text', bare_sentence);
	$.ajax({
		type: 'POST',
		url: url,
		data: fd,
		processData: false,
		contentType: false,
		success: function(response) {
      console.log(response)
			callback(response);
		}
	}).done(function(data) {
	});
}

// ------------------ questions per category --------------------------

// bully ###########################################################

function bully4(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
  response = ""
  if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>';
	}
  bully_dict.push([voice_emotion, text_emotion, aggression]);

	value_dict['bully'] = value/bully_value;
  value=0;
  console.log('bully chat-log')
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("chat-log").append("\n"+'bully '+ value_dict['bully'].toFixed(2) +':\n' + bully_dict);
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("chat-log").scrollTop = document.getElementById("chat-log").scrollHeight;
  document.getElementById("newchat").scrollTop = document.getElementById("newchat").scrollHeight;
  finalFeedback();
}


function bully3(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
  if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>';
	}
  bully_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(bully);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	bully_value += response_value;
	var index = bully.indexOf(response1);
	bully.splice(index, 1);
  response += response3;
  addLeo();
	speakVoice(response);
  read_or_listen(bully4);
}


function bully2(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
  if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>';
	}
  bully_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(bully);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	bully_value += response_value;
	var index = bully.indexOf(response1);
	bully.splice(index, 1);
  response += response3;
  addLeo();
	speakVoice(response);
  read_or_listen(bully3);
}


function bully1(){
	category_dict['bully'] = [];
	var response = random(bully);
	var response2 = response.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	bully_value += response_value;
	var index = bully.indexOf(response);
	bully.splice(index, 1);
  addLeo();
	speakVoice(response3);
  read_or_listen(bully2);
}

// victim ###########################################################

function victim4(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
  response = "";
  if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>';
	}
  victim_dict.push([voice_emotion, text_emotion, aggression]);
	value_dict['victim'] = value/victim_value;
  value=0;
  console.log('victim chat-log')
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("chat-log").append("\n"+'victim '+ value_dict['victim'].toFixed(2) +':\n' + victim_dict);
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("chat-log").scrollTop = document.getElementById("chat-log").scrollHeight;
  document.getElementById("newchat").scrollTop = document.getElementById("newchat").scrollHeight;
  finalFeedback();
}


function victim3(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
  if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>';
	}
  victim_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(victim);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	victim_value += response_value;
	var index = victim.indexOf(response1);
	victim.splice(index, 1);
  response += response3;
  addLeo();
	speakVoice(response);
  read_or_listen(victim4);
}


function victim2(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
	if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += "<br>You've got much more to you than you think "+name+".";
	}
  victim_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(victim);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	victim_value += response_value;
	var index = victim.indexOf(response1);
	victim.splice(index, 1);
  response += response3;
  addLeo();
	speakVoice(response);
  read_or_listen(victim3);
}


function victim1(){
	category_dict['victim'] = [];
	var response = random(victim);
	var response2 = response.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	victim_value += response_value;
	var index = victim.indexOf(response);
	victim.splice(index, 1);
  addLeo();
	speakVoice(response3);
  read_or_listen(victim2);
}

// sensitivity ###########################################################

function sensitivity4(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
  response = "";
  if (speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>';
	}
  sensitivity_dict.push([voice_emotion, text_emotion, aggression]);
	value_dict['sensitivity'] = value/sensitivity_value;
  value=0;
  console.log('sensitivity chat-log')
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("chat-log").append("\n"+'sensitivity '+ value_dict['sensitivity'].toFixed(2) +':\n' + sensitivity_dict);
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("chat-log").scrollTop = document.getElementById("chat-log").scrollHeight;
  document.getElementById("newchat").scrollTop = document.getElementById("newchat").scrollHeight;
	if (value_dict['sensitivity'] >= 0.5){
    addLeo();
    speakVoice(response);
		bully1();
	}
	else {
    finalFeedback();
	}
}


function sensitivity3(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
  if (speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>';
	}
  sensitivity_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(sensitivity);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	sensitivity_value += response_value;
	var index = sensitivity.indexOf(response1);
	sensitivity.splice(index, 1);
  response += response3;
  addLeo();
	speakVoice(response);
  read_or_listen(sensitivity4);
}


function sensitivity2(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
	if (speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>';
	}
  sensitivity_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(sensitivity);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	sensitivity_value += response_value;
	var index = sensitivity.indexOf(response1);
	sensitivity.splice(index, 1);
  response += response3;
  addLeo();
	speakVoice(response);
  read_or_listen(sensitivity3);
}


function sensitivity1(){
	category_dict['sensitivity'] = [];
	var response1 = random(sensitivity);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	sensitivity_value += response_value;
	var index = sensitivity.indexOf(response1);
	sensitivity.splice(index, 1);
  addLeo();
	speakVoice(response3);
  read_or_listen(sensitivity2);
}

// anger ###########################################################

function anger4(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
  response = "";
  if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>';
	}
  anger_dict.push([voice_emotion, text_emotion, aggression]);
	value_dict['anger'] = value/anger_value;
  value=0;
  console.log('anger chat-log')
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("chat-log").append("\n"+'anger '+ value_dict['anger'].toFixed(2) +':\n' + anger_dict);
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("chat-log").scrollTop = document.getElementById("chat-log").scrollHeight;
  document.getElementById("newchat").scrollTop = document.getElementById("newchat").scrollHeight;
	if (value_dict['anger'] >= 0.5){
    addLeo();
    speakVoice(response);
		victim1();
	}
	else {
    finalFeedback();
	}
}


function anger3(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
	if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>';
	}
  anger_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(anger);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	anger_value += response_value;
	var index = anger.indexOf(response1);
	anger.splice(index, 1);
  response += response3;
  addLeo();
	speakVoice(response);
  read_or_listen(anger4);
}


function anger2(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
	if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += "<br>You're so kind "+name+".";
	}
  anger_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(anger);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	anger_value += response_value;
	var index = anger.indexOf(response1);
	anger.splice(index, 1);
  response += response3;
  addLeo();
	speakVoice(response);
  read_or_listen(anger3);
}


function anger1(){
	category_dict['anger'] = [];
	var response = random(anger);
	var response2 = response.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	anger_value += response_value;
	var index = anger.indexOf(response);
	anger.splice(index, 1);
  addLeo();
	speakVoice(response3);
  read_or_listen(anger2);
}


// wellbeing ###########################################################

function wellbeing4(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
  if (speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    addLeo();
    speakVoice(response);
	}
  wellbeing_dict.push([voice_emotion, text_emotion, aggression]);
	value_dict['wellbeing'] = value/wellbeing_value;
  value=0;
  console.log('wellbeing chat-log')
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("chat-log").append("\n"+'wellbeing '+ value_dict['wellbeing'].toFixed(2) +':\n' + wellbeing_dict);
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("chat-log").scrollTop = document.getElementById("chat-log").scrollHeight;
  document.getElementById("newchat").scrollTop = document.getElementById("newchat").scrollHeight;
	if (value_dict['wellbeing'] >= 0.5){
		anger1();
	}
	else {
		sensitivity1();
	}
}


function wellbeing3(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
  if (speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>'
	}
  wellbeing_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(wellbeing);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	wellbeing_value += response_value;
	var index = wellbeing.indexOf(response1);
	wellbeing.splice(index, 1);
  response += "Hey "+name+". "+response3;
  addLeo();
	speakVoice(response);
  read_or_listen(wellbeing4);
}


function wellbeing2(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
  if (speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>'
	}
  wellbeing_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(wellbeing);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	wellbeing_value += response_value;
	var index = wellbeing.indexOf(response1);
	wellbeing.splice(index, 1);
  response += response3;
  addLeo();
	speakVoice(response);
  read_or_listen(wellbeing3);
}


function wellbeing1(){
	category_dict['wellbeing'] = [];
	var response = random(wellbeing);
	var response2 = response.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	wellbeing_value += response_value;
	var index = wellbeing.indexOf(response);
	wellbeing.splice(index, 1);
  addLeo();
	speakVoice(response3);
  read_or_listen(wellbeing2);
}

// mood ###########################################################

function mood4(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
  if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    addLeo();
    speakVoice("My dear "+name+"..."+response);
	}
  mood_dict.push([voice_emotion, text_emotion, aggression]);

	value_dict['mood'] = value/mood_value;
  value=0;
  console.log('mood chat-log')
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("chat-log").append('mood '+ value_dict['mood'].toFixed(2) +':\n' + mood_dict);
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("chat-log").scrollTop = document.getElementById("chat-log").scrollHeight;
  document.getElementById("newchat").scrollTop = document.getElementById("newchat").scrollHeight;
	if (value_dict['mood'] >= 0.5){
		wellbeing1();
	}
	else {
		sensitivity1();
	}
}


function mood3(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
  if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>'
	}
  mood_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(mood);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	mood_value += response_value;
	var index = mood.indexOf(response1);
	mood.splice(index, 1);
  response += response3;
  addLeo();
	speakVoice(response);
  read_or_listen(mood4);
}


function mood2(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
	if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>'
	}
  mood_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(mood);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	mood_value += response_value;
	var index = mood.indexOf(response1);
	mood.splice(index, 1);
  response += response3;
  addLeo();
	speakVoice(response);
  read_or_listen(mood3);
}


function mood1(){
	category_dict['mood'] = [];
	var response = random(mood);
	var response2 = response.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	mood_value += response_value;
	var index = mood.indexOf(response);
	mood.splice(index, 1);
  addLeo();
	speakVoice(response3);
  read_or_listen(mood2);
}

// interactions ###########################################################

function interactions4(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
  if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    addLeo();
    speakVoice(response);
	}
  interactions_dict.push([voice_emotion, text_emotion, aggression]);
	value_dict['interactions'] = value/interactions_value;
  value=0;
  console.log('interactions chat-log')
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("chat-log").append("\n"+'interactions '+ value_dict['interactions'].toFixed(2) +':\n' + interactions_dict);
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("newchat").scrollTop = document.getElementById("newchat").scrollHeight;
	if (value_dict['interactions'] >= 0.5){
		wellbeing1();
	}
	else {
		mood1();
	}
}


function interactions3(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
	if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>'
	}
  interactions_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(interactions);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	interactions_value += response_value;
	var index = interactions.indexOf(response1);
	interactions.splice(index, 1);
  response += response3;
  addLeo();
	speakVoice(response);
  read_or_listen(interactions4);
}


function interactions2(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
	if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>Let me tell you '+name+', '
	}
  interactions_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(interactions);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	interactions_value += response_value;
	var index = interactions.indexOf(response1);
	interactions.splice(index, 1);
  response += response3;
  addLeo();
	speakVoice(response);
  read_or_listen(interactions3);
}


function interactions1(){
	category_dict['interactions'] = [];
	var response = random(interactions);
	var response2 = response.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	interactions_value += response_value;
	var index = interactions.indexOf(response);
	interactions.splice(index, 1);
  addLeo();
	speakVoice(response3);
  read_or_listen(interactions2);
}

// selfesteem ##############################################################

function selfesteem4(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
  if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    addLeo();
    speakVoice(response);
	}
  selfesteem_dict.push([voice_emotion, text_emotion, aggression]);
	value_dict['selfesteem'] = value/selfesteem_value;
  value=0;
  console.log('selfesteem chat-log')
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("chat-log").append('selfesteem '+ value_dict['selfesteem'].toFixed(2) +':\n' + selfesteem_dict);
  document.getElementById("chat-log").appendChild(br);
  document.getElementById("newchat").scrollTop = document.getElementById("newchat").scrollHeight;
	if (value_dict['selfesteem'] >= 0.5){
		interactions1();
	}
	else {
		mood1();
	}
}


function selfesteem3(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
	if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>'+name+', '
	}
  selfesteem_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(selfesteem);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	selfesteem_value += response_value;
	var index = selfesteem.indexOf(response1);
	selfesteem.splice(index, 1);
  response += response3;
  addLeo();
	speakVoice(response);
  read_or_listen(selfesteem4);
}


function selfesteem2(result){
	speech = result[0];
	emotion = result[1]['list'];
  voice_emotion = emotion[0];
  text_emotion = emotion[1];
	aggression = emotion[2];
	response = "";
	if (!speech.includes('no') || negative.includes(voice_emotion)){
		value += response_value;
    response = random(supportive);
  	var index = supportive.indexOf(response);
  	supportive.splice(index, 1);
    response += '<br>'
	}
  selfesteem_dict.push([voice_emotion, text_emotion, aggression]);
	var response1 = random(selfesteem);
	var response2 = response1.split("*");
	var response3 = response2[0];
	response_value = parseFloat(response2[1]);
	selfesteem_value += response_value;
	var index = selfesteem.indexOf(response1);
	selfesteem.splice(index, 1);
  response += response3;
  addLeo();
  speakVoice(response);
  read_or_listen(selfesteem3);
}


function selfesteem1(){
	category_dict['selfesteem'] = [];
	var response1 = random(selfesteem);
	var response2 = response1.split("*");
	var response3 = response2[0];
  value = 0;
	response_value = parseFloat(response2[1]);
	selfesteem_value += response_value;
	var index = selfesteem.indexOf(response1);
	selfesteem.splice(index, 1);
  addLeo();
	speakVoice(response3);
  read_or_listen(selfesteem2);
}

// ##########################################################



// add bot message space to chatbox
function addLeo(){
  innerDiv = document.createElement('div');
  innerDiv.className = "leo messages"
  innerDiv2 = document.createElement('div');
  innerDiv2.className = "message "
  innerDiv2.id = messageCounter
  innerDiv.appendChild(innerDiv2);
  document.getElementsByClassName("chat")[0].appendChild(innerDiv);
}

// add user message space to chatbox
function addMe(text30){
  if (text30){
    innerDiv = document.createElement('div');
    innerDiv.className = "mine messages"
    innerDiv2 = document.createElement('div');
    innerDiv2.className = "message "
    innerDiv2.id = messageCounter
    innerDiv.appendChild(innerDiv2);
    document.getElementsByClassName("chat")[0].appendChild(innerDiv);
  }
}


// random function
function random(choices) {
  var index = Math.floor(Math.random() * choices.length);
  return choices[index];
}

function listen(callback){
	let speech, emotion;
	var constraints = { audio: true, video:false }
	navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
		console.log("getUserMedia() success, stream created, initializing Recorder.js ...");
		audioContext = new AudioContext();
		gumStream = stream;
		input = audioContext.createMediaStreamSource(stream);
		rec = new Recorder(input,{numChannels:1});
		rec.record();
    // alert("works");
	});
	// const SpeechRecognition = new webkitSpeechRecognition() || new SpeechRecognition();
	const recognition = new webkitSpeechRecognition() || new SpeechRecognition();
	recognition.lang = 'en-US';
  recognition.continuous = false;
	recognition.start();

	recognition.addEventListener('speechstart', () => {
    document.getElementById("chat-message-mic").style.background='#f7f74d';
		console.log('Speech has been detected.');
	});
  recognition.onresult = function(e) {
    document.getElementById("chat-message-mic").style.background='#2ade51';
		let last = e.results.length - 1;
		let text = e.results[last][0].transcript;
    addMe(text);
		speech = text;

		recognition.stop();
		rec.stop();
		gumStream.getAudioTracks()[0].stop();
		rec.exportWAV(function(blob){
			var url = "blob";
			var fd = new FormData();
			fd.append('audio', blob, 'test.wav');
			fd.append('text', speech);
			$.ajax({
				type: 'POST',
				url: url,
				data: fd,
				processData: false,
				contentType: false,
				success: function(response) {
          console.log(response)
          emotion = response['list'];
          document.getElementById(messageCounter).innerHTML = emotion[3];
          messageCounter++;
          console.log(innerDiv)
          document.getElementById("newchat").scrollTop = document.getElementById("newchat").scrollHeight;
          if(save_text==1){
            total_text+=emotion[3] + ';';
            save_text=0;
          } else if(save_text==2){
            name=emotion[3];
            total_text+=emotion[3] + ';';
            save_text=0;
          }
					callback([emotion[3], response]);
				}
			}).done(function(data) {
				emotion = data;
			});
		});
		rec.clear();
		return;
  }

	// recognition.addEventListener('result', (e) => {
	// 	console.log('Result has been detected');
  //   document.getElementById("chat-message-mic").style.background='#2ade51';
	// 	let last = e.results.length - 1;
	// 	let text = e.results[last][0].transcript;
  //   addMe(text);
	// 	speech = text;
  //
	// 	recognition.stop();
	// 	rec.stop();
	// 	gumStream.getAudioTracks()[0].stop();
	// 	rec.exportWAV(function(blob){
	// 		var url = "blob";
	// 		var fd = new FormData();
	// 		fd.append('audio', blob, 'test.wav');
	// 		fd.append('text', speech);
	// 		$.ajax({
	// 			type: 'POST',
	// 			url: url,
	// 			data: fd,
	// 			processData: false,
	// 			contentType: false,
	// 			success: function(response) {
  //         console.log(response)
  //         emotion = response['list'];
  //         document.getElementById(messageCounter).innerHTML = emotion[3];
  //         messageCounter++;
  //         console.log(innerDiv)
  //         document.getElementById("newchat").scrollTop = document.getElementById("newchat").scrollHeight;
  //         if(save_text==1){
  //           total_text+=emotion[3] + ';';
  //           save_text=0;
  //         } else if(save_text==2){
  //           name=emotion[3];
  //           total_text+=emotion[3] + ';';
  //           save_text=0;
  //         }
	// 				callback([emotion[3], response]);
	// 			}
	// 		}).done(function(data) {
	// 			emotion = data;
	// 		});
	// 	});
	// 	rec.clear();
	// 	return;
	// });
	recognition.addEventListener('speechend', () => {
		return;
	});
	return;
	recognition.addEventListener('error', (e) => {
		outputBot.textContent = 'Error: ' + e.error;
	});
};

// listen to user
function listen2(callback){
	let speech, emotion;
	var constraints = { audio: true, video:false }
	navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
		console.log("getUserMedia() success, stream created, initializing Recorder.js ...");
		audioContext = new AudioContext();
		gumStream = stream;
		input = audioContext.createMediaStreamSource(stream);
		rec = new Recorder(input,{numChannels:1});
		rec.record();
    // alert("works");
	});
	// const SpeechRecognition = new webkitSpeechRecognition() || new SpeechRecognition();
	const recognition = new webkitSpeechRecognition() || new SpeechRecognition();
	recognition.lang = 'en-US';
  recognition.continuous = false;
	recognition.start();

	recognition.addEventListener('speechstart', () => {
    document.getElementById("chat-message-mic").style.background='#f7f74d';
		console.log('Speech has been detected.');
	});

	recognition.addEventListener('result', (e) => {
		console.log('Result has been detected');
    document.getElementById("chat-message-mic").style.background='#2ade51';
		let last = e.results.length - 1;
		let text = e.results[last][0].transcript;
    addMe(text);
		speech = text;

		recognition.stop();
		rec.stop();
		gumStream.getAudioTracks()[0].stop();
		rec.exportWAV(function(blob){
			var url = "blob";
			var fd = new FormData();
			fd.append('audio', blob, 'test.wav');
			fd.append('text', speech);
			$.ajax({
				type: 'POST',
				url: url,
				data: fd,
				processData: false,
				contentType: false,
				success: function(response) {
          console.log(response)
          emotion = response['list'];
          document.getElementById(messageCounter).innerHTML = emotion[3];
          messageCounter++;
          console.log(innerDiv)
          document.getElementById("newchat").scrollTop = document.getElementById("newchat").scrollHeight;
          if(save_text==1){
            total_text+=emotion[3] + ';';
            save_text=0;
          } else if(save_text==2){
            name=emotion[3];
            total_text+=emotion[3] + ';';
            save_text=0;
          }
					callback([emotion[3], response]);
				}
			}).done(function(data) {
				emotion = data;
			});
		});
		rec.clear();
		return;
	});
	recognition.addEventListener('speechend', () => {
		return;
	});
	return;
	recognition.addEventListener('error', (e) => {
		outputBot.textContent = 'Error: ' + e.error;
	});
};


function read(callback){
  var text2 = document.getElementById("typefield").value;

  addMe(text2);
  speech = text2;
  document.getElementById(messageCounter).innerHTML = text2
  messageCounter++;
  console.log(innerDiv)
  document.getElementById("newchat").scrollTop = document.getElementById("newchat").scrollHeight;
  var fd = new FormData();
  fd.append('text', text2);
  document.getElementById("typefield").value ="";
  $.ajax({
    type: 'POST',
    url: "text",
    data: fd,
    processData: false,
    contentType: false,
    success: function(response) {
      console.log(response)
      console.log("YAY")
      if(save_text==1){
        total_text+=text2 + ';';
        save_text=0;
      } else if(save_text==2){
        name=text2;
        total_text+=text2 + ';';
        save_text=0;
      }
      callback([text2, response]);
    }
  }).done(function(data) {
    console.log("yay2")
    emotion = data;
  });
  console.log("yay3")
  return;
}
